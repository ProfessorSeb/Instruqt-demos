#!/bin/bash
set -euxo pipefail

# Check OpenClaw gateway is still running
if ! openclaw gateway status 2>/dev/null | grep -qi "running\|active"; then
  fail-message "OpenClaw gateway is not running. Start it with: openclaw gateway start"
fi

# Check AgentGateway is still up
RUNNING=$(kubectl get pods -n agentgateway-system --field-selector=status.phase=Running --no-headers 2>/dev/null | wc -l)
if [ "$RUNNING" -lt 1 ]; then
  fail-message "AgentGateway pods are not running. Check: kubectl get pods -n agentgateway-system"
fi

# Verify the full stack responds end-to-end through OpenClaw â†’ AgentGateway
RESPONSE=$(openclaw chat --message "Reply with only the word CONNECTED" 2>/dev/null || echo "")
if [ -z "$RESPONSE" ]; then
  fail-message "Could not get a response through OpenClaw. Check that the gateway is running and AgentGateway is reachable at localhost:8080."
fi

echo "Challenge 4 check passed"
