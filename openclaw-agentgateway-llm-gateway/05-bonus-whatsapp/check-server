#!/bin/bash
set -euxo pipefail

# Check WhatsApp is configured in openclaw.json
if ! grep -q "whatsapp" ~/.openclaw/openclaw.json 2>/dev/null; then
  fail-message "WhatsApp channel is not configured. Add it with: openclaw configure --set channels.whatsapp.dmPolicy=pairing"
fi

# Check credentials exist (QR scan completed)
if [ ! -f ~/.openclaw/credentials/whatsapp/default/creds.json ] && \
   [ ! -f ~/.openclaw/credentials/whatsapp/creds.json ]; then
  fail-message "WhatsApp credentials not found — looks like you haven't linked a WhatsApp account yet. Run: openclaw channels login --channel whatsapp"
fi

# Check channel status
STATUS=$(openclaw channels status 2>/dev/null || echo "")
if echo "$STATUS" | grep -qi "whatsapp.*linked\|whatsapp.*connected"; then
  echo "WhatsApp linked!"
else
  fail-message "WhatsApp is not linked. Run 'openclaw channels status' to check, then re-run 'openclaw channels login --channel whatsapp' if needed."
fi

echo "Bonus challenge check passed — well done!"
