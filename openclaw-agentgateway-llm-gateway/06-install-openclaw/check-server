#!/bin/bash
set -euxo pipefail

# Verify logs were captured
if [ ! -f /tmp/gateway-logs.txt ]; then
  fail-message "Gateway logs not found at /tmp/gateway-logs.txt. Run: kubectl logs -n agentgateway-system deployment/agentgateway-proxy --tail=100 > /tmp/gateway-logs.txt"
fi

# Verify the gateway is still responding
HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
  -X POST http://localhost:8080/v1/chat/completions \
  -H "Content-Type: application/json" \
  -d '{"model":"gpt-4o-mini","messages":[{"role":"user","content":"ping"}]}' \
  --max-time 15)

if [ "$HTTP_CODE" != "200" ]; then
  fail-message "Gateway returned HTTP $HTTP_CODE. Expected 200. Is the port-forward still running?"
fi

# Verify pods are running
READY=$(kubectl get pods -n agentgateway-system \
  -l app.kubernetes.io/name=agentgateway \
  -o jsonpath='{.items[0].status.conditions[?(@.type=="Ready")].status}' 2>/dev/null || echo "")

if [ "$READY" != "True" ]; then
  fail-message "AgentGateway pod is not Ready. Check: kubectl get pods -n agentgateway-system"
fi

echo "Challenge 6 passed â€” gateway is observable, healthy, and processing traffic."
