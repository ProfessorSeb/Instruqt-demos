#!/bin/bash
set -euo pipefail

# Capture gateway logs
kubectl logs -n agentgateway-system deployment/agentgateway-proxy \
  --tail=100 > /tmp/gateway-logs.txt

echo "Log lines captured: $(wc -l < /tmp/gateway-logs.txt)"

# Make a test request through the gateway
HTTP_CODE=$(curl -s -o /tmp/gateway-test-response.json -w "%{http_code}" \
  -X POST http://localhost:8080/v1/chat/completions \
  -H "Content-Type: application/json" \
  -d '{"model":"gpt-4o-mini","messages":[{"role":"user","content":"Reply with: GATEWAY_HEALTHY"}]}' \
  --max-time 15)

echo "Gateway response: $HTTP_CODE"
cat /tmp/gateway-test-response.json

echo "Challenge 6 solved"
