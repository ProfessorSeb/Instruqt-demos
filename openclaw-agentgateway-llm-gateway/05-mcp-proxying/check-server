#!/bin/bash
set -euxo pipefail

# Verify the second backend was created
if ! kubectl get agentgatewaybackend openai-smart -n agentgateway-system &>/dev/null; then
  fail-message "AgentgatewayBackend 'openai-smart' not found. Apply /root/openai-smart-backend.yaml"
fi

# Verify the original backend is still intact
if ! kubectl get agentgatewaybackend openai -n agentgateway-system &>/dev/null; then
  fail-message "Original backend 'openai' is missing. Did you accidentally delete it?"
fi

# Verify the gateway is still responding on the original route
HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
  -X POST http://localhost:8080/v1/chat/completions \
  -H "Content-Type: application/json" \
  -d '{"model":"gpt-4o-mini","messages":[{"role":"user","content":"ping"}]}' \
  --max-time 15)

if [ "$HTTP_CODE" != "200" ]; then
  fail-message "Gateway returned HTTP $HTTP_CODE on the original route. Expected 200."
fi

echo "Challenge 5 passed â€” two model backends registered and gateway healthy."
