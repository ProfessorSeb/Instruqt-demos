#!/bin/bash
set -euo pipefail

if ! kubectl get secret openai-secret -n agentgateway-system &>/dev/null; then
  fail-message "Secret 'openai-secret' not found. Apply the secret manifest from the assignment."
fi

if ! kubectl get agentgatewaybackend openai -n agentgateway-system &>/dev/null; then
  fail-message "AgentgatewayBackend 'openai' not found. Apply the backend manifest."
fi

GW_STATUS=$(kubectl get gateway agentgateway-proxy -n agentgateway-system \
  -o jsonpath='{.status.conditions[?(@.type=="Programmed")].status}' 2>/dev/null)
if [ "$GW_STATUS" != "True" ]; then
  fail-message "Gateway 'agentgateway-proxy' is not Programmed. Check: kubectl describe gateway agentgateway-proxy -n agentgateway-system"
fi

# Ensure port-forward is running (detached)
if ! kill -0 "$(cat /tmp/port-forward.pid 2>/dev/null)" 2>/dev/null; then
  nohup kubectl port-forward deployment/agentgateway-proxy \
    -n agentgateway-system 8080:80 \
    > /tmp/port-forward.log 2>&1 &
  echo $! > /tmp/port-forward.pid
  sleep 3
fi

HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
  -X POST http://localhost:8080/v1/chat/completions \
  -H "Content-Type: application/json" \
  -d '{"model":"gpt-4o-mini","messages":[{"role":"user","content":"ping"}]}' \
  --max-time 15)

if [ "$HTTP_CODE" != "200" ]; then
  fail-message "Gateway returned HTTP $HTTP_CODE. Check: curl localhost:8080/v1/chat/completions"
fi

[ -f /root/openai-route.yaml ] || \
  kubectl get httproute openai -n agentgateway-system -o yaml > /root/openai-route.yaml

echo "Challenge 3 passed â€” LLM traffic flowing through AgentGateway."
