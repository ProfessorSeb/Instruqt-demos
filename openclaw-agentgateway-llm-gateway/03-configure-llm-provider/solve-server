#!/bin/bash
set -euxo pipefail
source ~/.bashrc || true

kubectl create namespace llm-gateway --dry-run=client -o yaml | kubectl apply -f -

kubectl create secret generic openai-secret \
  --namespace agentgateway-system \
  --from-literal="Authorization=Bearer ${OPENAI_API_KEY}" \
  --dry-run=client -o yaml | kubectl apply -f -

kubectl apply -f - <<'EOF'
apiVersion: agentgateway.dev/v1alpha1
kind: AgentgatewayBackend
metadata:
  name: openai-backend
  namespace: agentgateway-system
spec:
  ai:
    provider:
      openai:
        model: gpt-4o-mini
  policies:
    auth:
      secretRef:
        name: openai-secret
EOF

kubectl apply -f - <<'EOF'
apiVersion: gateway.networking.k8s.io/v1
kind: Gateway
metadata:
  name: ai-gateway
  namespace: agentgateway-system
spec:
  gatewayClassName: agentgateway
  listeners:
  - name: http
    protocol: HTTP
    port: 8080
---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: openai-route
  namespace: agentgateway-system
spec:
  parentRefs:
  - name: ai-gateway
    namespace: agentgateway-system
  rules:
  - matches:
    - path:
        type: PathPrefix
        value: /openai
    backendRefs:
    - group: agentgateway.dev
      kind: AgentgatewayBackend
      name: openai-backend
EOF

kubectl wait --for=condition=Programmed gateway/ai-gateway \
  -n agentgateway-system --timeout=60s

kubectl get httproute openai-route -n agentgateway-system -o yaml > /root/openai-route.yaml

kubectl port-forward -n agentgateway-system svc/ai-gateway 8080:8080 &
sleep 3
