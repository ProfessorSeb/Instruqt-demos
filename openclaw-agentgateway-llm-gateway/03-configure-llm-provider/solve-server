#!/bin/bash
set -euxo pipefail
source ~/.bashrc || true

# Create OpenAI secret
kubectl apply -f- <<YAML
apiVersion: v1
kind: Secret
metadata:
  name: openai-secret
  namespace: agentgateway-system
type: Opaque
stringData:
  Authorization: ${OPENAI_API_KEY}
YAML

# Create AgentgatewayBackend
kubectl apply -f- <<'YAML'
apiVersion: agentgateway.dev/v1alpha1
kind: AgentgatewayBackend
metadata:
  name: openai
  namespace: agentgateway-system
spec:
  ai:
    provider:
      openai:
        model: gpt-4o-mini
  policies:
    auth:
      secretRef:
        name: openai-secret
YAML

# Create Gateway + HTTPRoute
kubectl apply -f- <<'YAML'
apiVersion: gateway.networking.k8s.io/v1
kind: Gateway
metadata:
  name: agentgateway-proxy
  namespace: agentgateway-system
spec:
  gatewayClassName: agentgateway
  listeners:
  - protocol: HTTP
    port: 80
    name: http
    allowedRoutes:
      namespaces:
        from: All
---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: openai
  namespace: agentgateway-system
spec:
  parentRefs:
  - name: agentgateway-proxy
    namespace: agentgateway-system
  rules:
  - backendRefs:
    - name: openai
      namespace: agentgateway-system
      group: agentgateway.dev
      kind: AgentgatewayBackend
YAML

kubectl wait --for=condition=Programmed gateway/agentgateway-proxy \
  -n agentgateway-system --timeout=60s

# Wait for the proxy pod to be running before port-forwarding
kubectl wait --for=condition=Ready pod \
  -l app.kubernetes.io/name=agentgateway-proxy \
  -n agentgateway-system --timeout=60s 2>/dev/null || \
kubectl wait --for=condition=Ready pod \
  -l app=agentgateway-proxy \
  -n agentgateway-system --timeout=60s 2>/dev/null || \
kubectl wait --for=condition=Ready pods --all \
  -n agentgateway-system --timeout=60s

# Detach port-forward properly with nohup
nohup kubectl port-forward deployment/agentgateway-proxy \
  -n agentgateway-system 8080:80 \
  > /tmp/port-forward.log 2>&1 &
echo $! > /tmp/port-forward.pid
sleep 3

# Save route manifest for kill switch
kubectl get httproute openai -n agentgateway-system -o yaml > /root/openai-route.yaml
