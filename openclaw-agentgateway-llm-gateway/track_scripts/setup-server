#!/bin/bash

# Wait for instruqt bootstrap
until [ -f /opt/instruqt/bootstrap/host-bootstrap-completed ]; do
  sleep 1
done

set -euxo pipefail

set-workdir /root

# Shell conveniences
cat >> ~/.bashrc << 'EOF'
alias k=kubectl
complete -F __start_kubectl k
source /etc/bash_completion
EOF

# Store OpenAI key
if [ -n "${OPENAI_API_KEY:-}" ]; then
  echo "export OPENAI_API_KEY=${OPENAI_API_KEY}" >> ~/.bashrc
  echo "${OPENAI_API_KEY}" > /root/.openai-api-key
  echo "=== OpenAI API key stored ==="
else
  echo "=== WARNING: OPENAI_API_KEY not set ==="
fi

# Start k3d cluster (pre-installed in image) with port mapping
# localhost:8080 â†’ port 80 on the loadbalancer (AgentGateway listener)
echo "=== Creating k3d cluster ==="
k3d cluster create agentgateway \
  --port "8080:80@loadbalancer" \
  --port "8443:443@loadbalancer" \
  --wait

kubectl cluster-info
kubectl wait --for=condition=Ready nodes --all --timeout=120s

# Install Gateway API CRDs
echo "=== Installing Gateway API CRDs ==="
kubectl apply -f https://github.com/kubernetes-sigs/gateway-api/releases/download/v1.4.0/standard-install.yaml

echo "=== Track setup complete ==="
