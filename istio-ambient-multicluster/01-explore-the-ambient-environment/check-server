#!/bin/bash
set -euxo pipefail

# Check that the verification file exists
if [ ! -f /root/environment-verified.txt ]; then
  fail-message "Please create /root/environment-verified.txt after exploring the environment."
  exit 1
fi

# Verify Istio pods are running
ISTIOD_READY=$(kubectl get pods -n istio-system -l app=istiod --no-headers | grep -c Running || true)
if [ "$ISTIOD_READY" -lt 1 ]; then
  fail-message "istiod is not running in istio-system."
  exit 1
fi

ZTUNNEL_READY=$(kubectl get daemonset ztunnel -n istio-system -o jsonpath='{.status.numberReady}')
if [ "$ZTUNNEL_READY" -lt 1 ]; then
  fail-message "ztunnel DaemonSet is not ready."
  exit 1
fi

echo "Challenge 1 passed!"
