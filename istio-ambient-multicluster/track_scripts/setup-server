#!/bin/bash
set -euxo pipefail

# ──────────────────────────────────────────────
# Wait for Instruqt bootstrap
# ──────────────────────────────────────────────
until [ -f /opt/instruqt/bootstrap/host-bootstrap-completed ]; do
  echo "Waiting for Instruqt bootstrap..."
  sleep 2
done

# ──────────────────────────────────────────────
# Workdir + shell config
# ──────────────────────────────────────────────
apt-get update && apt-get install -y make

cd /root

cat >> /root/.bashrc << 'BASHRC'
export WORKDIR=/root
cd $WORKDIR
alias k=kubectl
alias kc1='kubectl --context=k3d-cluster-1'
alias kc2='kubectl --context=k3d-cluster-2'
export CTX_CLUSTER1=k3d-cluster-1
export CTX_CLUSTER2=k3d-cluster-2
BASHRC

# Source for this script
export CTX_CLUSTER1=k3d-cluster-1
export CTX_CLUSTER2=k3d-cluster-2

# Vim config
cat > /root/.vimrc << 'VIMRC'
set expandtab
set tabstop=2
set shiftwidth=2
set autoindent
syntax on
VIMRC

# ──────────────────────────────────────────────
# Create TWO k3d clusters
# ──────────────────────────────────────────────
k3d cluster create cluster-1 --agents 1 --k3s-arg '--disable=traefik@server:*' --wait
k3d cluster create cluster-2 --agents 1 --k3s-arg '--disable=traefik@server:*' --wait

# Verify clusters are ready
kubectl --context=$CTX_CLUSTER1 wait --for=condition=Ready nodes --all --timeout=120s
kubectl --context=$CTX_CLUSTER2 wait --for=condition=Ready nodes --all --timeout=120s

# ──────────────────────────────────────────────
# Install istioctl
# ──────────────────────────────────────────────
cd /root
curl -L https://istio.io/downloadIstio | ISTIO_VERSION=1.25.2 sh -
cp istio-1.25.2/bin/istioctl /usr/local/bin/
istioctl version --remote=false

# ──────────────────────────────────────────────
# Generate shared CA certificates
# ──────────────────────────────────────────────
cd /root/istio-1.25.2
mkdir -p certs && cd certs
make -f ../tools/certs/Makefile.selfsigned.mk root-ca
make -f ../tools/certs/Makefile.selfsigned.mk cluster1-cacerts
make -f ../tools/certs/Makefile.selfsigned.mk cluster2-cacerts

# Create istio-system namespace and load certs
kubectl --context=$CTX_CLUSTER1 create ns istio-system
kubectl --context=$CTX_CLUSTER2 create ns istio-system

kubectl --context=$CTX_CLUSTER1 create secret generic cacerts -n istio-system \
  --from-file=cluster1/ca-cert.pem \
  --from-file=cluster1/ca-key.pem \
  --from-file=cluster1/root-cert.pem \
  --from-file=cluster1/cert-chain.pem

kubectl --context=$CTX_CLUSTER2 create secret generic cacerts -n istio-system \
  --from-file=cluster2/ca-cert.pem \
  --from-file=cluster2/ca-key.pem \
  --from-file=cluster2/root-cert.pem \
  --from-file=cluster2/cert-chain.pem

# ──────────────────────────────────────────────
# Install Istio ambient on cluster-1
# ──────────────────────────────────────────────
cat > /root/cluster-1.yaml << 'EOF'
apiVersion: install.istio.io/v1alpha1
kind: IstioOperator
spec:
  profile: ambient
  values:
    global:
      meshID: mesh1
      multiCluster:
        clusterName: cluster1
      network: network1
    cni:
      repair:
        enabled: false
  components:
    cni:
      namespace: istio-system
      enabled: true
EOF

istioctl install --context=$CTX_CLUSTER1 -f /root/cluster-1.yaml -y

# Wait for CNI and ztunnel DaemonSets with retries (k3d can be slow)
for ds in istio-cni-node ztunnel; do
  for i in $(seq 1 6); do
    kubectl --context=$CTX_CLUSTER1 -n istio-system rollout status daemonset/$ds --timeout=120s && break
    echo "Retry $i for $ds on cluster-1..."
    sleep 10
  done
done

kubectl --context=$CTX_CLUSTER1 label namespace istio-system topology.istio.io/network=network1

# ──────────────────────────────────────────────
# Install Istio ambient on cluster-2
# ──────────────────────────────────────────────
cat > /root/cluster-2.yaml << 'EOF'
apiVersion: install.istio.io/v1alpha1
kind: IstioOperator
spec:
  profile: ambient
  values:
    global:
      meshID: mesh1
      multiCluster:
        clusterName: cluster2
      network: network2
    cni:
      repair:
        enabled: false
  components:
    cni:
      namespace: istio-system
      enabled: true
EOF

istioctl install --context=$CTX_CLUSTER2 -f /root/cluster-2.yaml -y

# Wait for CNI and ztunnel DaemonSets with retries
for ds in istio-cni-node ztunnel; do
  for i in $(seq 1 6); do
    kubectl --context=$CTX_CLUSTER2 -n istio-system rollout status daemonset/$ds --timeout=120s && break
    echo "Retry $i for $ds on cluster-2..."
    sleep 10
  done
done

kubectl --context=$CTX_CLUSTER2 label namespace istio-system topology.istio.io/network=network2

# ──────────────────────────────────────────────
# Deploy east-west gateways
# ──────────────────────────────────────────────
cd /root/istio-1.25.2

# Try with --ambient flag first, fall back to without
if samples/multicluster/gen-eastwest-gateway.sh --help 2>&1 | grep -q ambient; then
  samples/multicluster/gen-eastwest-gateway.sh --network network1 --ambient | \
    kubectl apply --context=$CTX_CLUSTER1 -f -
  samples/multicluster/gen-eastwest-gateway.sh --network network2 --ambient | \
    kubectl apply --context=$CTX_CLUSTER2 -f -
else
  samples/multicluster/gen-eastwest-gateway.sh --network network1 | \
    kubectl apply --context=$CTX_CLUSTER1 -f -
  samples/multicluster/gen-eastwest-gateway.sh --network network2 | \
    kubectl apply --context=$CTX_CLUSTER2 -f -
fi

# Wait for east-west gateways
kubectl --context=$CTX_CLUSTER1 -n istio-system wait --for=condition=Available deployment/istio-eastwestgateway --timeout=300s || true
kubectl --context=$CTX_CLUSTER2 -n istio-system wait --for=condition=Available deployment/istio-eastwestgateway --timeout=300s || true

# Expose services via east-west gateway
kubectl --context=$CTX_CLUSTER1 apply -n istio-system -f samples/multicluster/expose-services.yaml
kubectl --context=$CTX_CLUSTER2 apply -n istio-system -f samples/multicluster/expose-services.yaml

# ──────────────────────────────────────────────
# Exchange remote secrets for cross-cluster discovery
# ──────────────────────────────────────────────
istioctl create-remote-secret --context=$CTX_CLUSTER1 --name=cluster1 | \
  kubectl apply --context=$CTX_CLUSTER2 -f -

istioctl create-remote-secret --context=$CTX_CLUSTER2 --name=cluster2 | \
  kubectl apply --context=$CTX_CLUSTER1 -f -

# ──────────────────────────────────────────────
# Wait for all Istio components to be ready
# ──────────────────────────────────────────────
for ctx in $CTX_CLUSTER1 $CTX_CLUSTER2; do
  kubectl --context=$ctx -n istio-system wait --for=condition=Ready pods --all --timeout=300s
done

# ──────────────────────────────────────────────
# Pre-pull and import images
# ──────────────────────────────────────────────
docker pull hashicorp/http-echo:1.0
docker pull curlimages/curl:8.5.0

k3d image import hashicorp/http-echo:1.0 curlimages/curl:8.5.0 -c cluster-1
k3d image import hashicorp/http-echo:1.0 curlimages/curl:8.5.0 -c cluster-2

echo "Setup complete!"
