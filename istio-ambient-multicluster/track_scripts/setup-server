#!/bin/bash
set -euxo pipefail

# ──────────────────────────────────────────────
# Wait for Instruqt bootstrap
# ──────────────────────────────────────────────
until [ -f /opt/instruqt/bootstrap/host-bootstrap-completed ]; do
  echo "Waiting for Instruqt bootstrap..."
  sleep 2
done

# ──────────────────────────────────────────────
# Workdir + shell config
# ──────────────────────────────────────────────
cd /root

cat >> /root/.bashrc << 'BASHRC'
export WORKDIR=/root
cd $WORKDIR
alias k=kubectl
BASHRC

# Vim config
cat > /root/.vimrc << 'VIMRC'
set expandtab
set tabstop=2
set shiftwidth=2
set autoindent
syntax on
VIMRC

# ──────────────────────────────────────────────
# Create ONE k3d cluster
# ──────────────────────────────────────────────
k3d cluster create my-k8s-cluster --agents 1 --k3s-arg '--disable=traefik@server:*' --wait
kubectl wait --for=condition=Ready nodes --all --timeout=120s

# ──────────────────────────────────────────────
# Install istioctl + Helm repo
# ──────────────────────────────────────────────
export ISTIO_VERSION=1.25.2

curl -L https://istio.io/downloadIstio | ISTIO_VERSION=$ISTIO_VERSION sh -
cp istio-$ISTIO_VERSION/bin/istioctl /usr/local/bin/
istioctl version --remote=false

helm repo add istio https://istio-release.storage.googleapis.com/charts
helm repo update

# ──────────────────────────────────────────────
# Pre-pull Istio images into k3d cluster
# ──────────────────────────────────────────────
for img in pilot install-cni ztunnel proxyv2; do
  docker pull docker.io/istio/$img:$ISTIO_VERSION
done

k3d image import \
  docker.io/istio/pilot:$ISTIO_VERSION \
  docker.io/istio/install-cni:$ISTIO_VERSION \
  docker.io/istio/ztunnel:$ISTIO_VERSION \
  docker.io/istio/proxyv2:$ISTIO_VERSION \
  -c my-k8s-cluster

# ──────────────────────────────────────────────
# Install Istio ambient via Helm
# ──────────────────────────────────────────────
kubectl create ns istio-system

helm install istio-base istio/base -n istio-system \
  --version $ISTIO_VERSION --wait

helm install istiod istio/istiod -n istio-system \
  --version $ISTIO_VERSION --wait --timeout 5m \
  --set profile=ambient

helm install istio-cni istio/cni -n istio-system \
  --version $ISTIO_VERSION \
  --set profile=ambient

# Wait for CNI DaemonSet with retries
for i in $(seq 1 12); do
  kubectl -n istio-system rollout status daemonset/istio-cni-node --timeout=120s && break
  echo "Retry $i for istio-cni-node..."
  sleep 15
done

helm install ztunnel istio/ztunnel -n istio-system \
  --version $ISTIO_VERSION

# Wait for ztunnel DaemonSet with retries
for i in $(seq 1 12); do
  kubectl -n istio-system rollout status daemonset/ztunnel --timeout=120s && break
  echo "Retry $i for ztunnel..."
  sleep 15
done

# ──────────────────────────────────────────────
# Wait for all Istio components to be ready
# ──────────────────────────────────────────────
kubectl -n istio-system wait --for=condition=Ready pods --all --timeout=300s

# ──────────────────────────────────────────────
# Pre-pull and import app images
# ──────────────────────────────────────────────
docker pull hashicorp/http-echo:1.0
docker pull curlimages/curl:8.5.0

k3d image import hashicorp/http-echo:1.0 curlimages/curl:8.5.0 -c my-k8s-cluster

echo "Setup complete!"
