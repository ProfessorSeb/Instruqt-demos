#!/bin/bash
set -euxo pipefail

export CTX_CLUSTER1=k3d-cluster-1
export CTX_CLUSTER2=k3d-cluster-2

# Apply Telemetry CR
for ctx in $CTX_CLUSTER1 $CTX_CLUSTER2; do
  kubectl --context=$ctx apply -n accounts -f - <<EOF
apiVersion: telemetry.istio.io/v1
kind: Telemetry
metadata:
  name: accounts-telemetry
spec:
  metrics:
  - providers:
    - name: prometheus
    overrides:
    - match:
        metric: REQUEST_COUNT
      tagOverrides:
        error_type:
          operation: UPSERT
          value: "response.code >= 500 ? 'server_error' : (response.code >= 400 ? 'client_error' : 'none')"
        slow_request:
          operation: UPSERT
          value: "response.duration > 1000 ? 'true' : 'false'"
        source_namespace:
          operation: UPSERT
          value: "source.namespace | 'unknown'"
  accessLogging:
  - providers:
    - name: envoy
EOF
done

# Create GitOps structure
mkdir -p /root/mesh-lab/{base,clusters/{cluster-1,cluster-2},apps/{accounts,finance}}

cat > /root/mesh-lab/base/kustomization.yaml << 'EOF'
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
- namespace-accounts.yaml
- namespace-finance.yaml
- telemetry.yaml
EOF

cat > /root/mesh-lab/base/namespace-accounts.yaml << 'EOF'
apiVersion: v1
kind: Namespace
metadata:
  name: accounts
  labels:
    istio.io/dataplane-mode: ambient
EOF

cat > /root/mesh-lab/base/namespace-finance.yaml << 'EOF'
apiVersion: v1
kind: Namespace
metadata:
  name: finance
  labels:
    istio.io/dataplane-mode: ambient
EOF

cat > /root/mesh-lab/base/telemetry.yaml << 'EOF'
apiVersion: telemetry.istio.io/v1
kind: Telemetry
metadata:
  name: accounts-telemetry
  namespace: accounts
spec:
  metrics:
  - providers:
    - name: prometheus
    overrides:
    - match:
        metric: REQUEST_COUNT
      tagOverrides:
        error_type:
          operation: UPSERT
          value: "response.code >= 500 ? 'server_error' : (response.code >= 400 ? 'client_error' : 'none')"
EOF

for cluster in cluster-1 cluster-2; do
  cat > /root/mesh-lab/clusters/$cluster/kustomization.yaml << EOF
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
- ../../base
- authorization-policies.yaml
EOF

  cat > /root/mesh-lab/clusters/$cluster/authorization-policies.yaml << 'EOF'
apiVersion: security.istio.io/v1
kind: AuthorizationPolicy
metadata:
  name: deny-all
  namespace: accounts
spec:
  {}
---
apiVersion: security.istio.io/v1
kind: AuthorizationPolicy
metadata:
  name: allow-from-finance
  namespace: accounts
spec:
  action: ALLOW
  rules:
  - from:
    - source:
        namespaces: ["finance"]
EOF
done

cat > /root/mesh-lab/apps/accounts/deployment.yaml << 'EOF'
apiVersion: apps/v1
kind: Deployment
metadata:
  name: accounts
  namespace: accounts
spec:
  replicas: 1
  selector:
    matchLabels:
      app: accounts
  template:
    metadata:
      labels:
        app: accounts
    spec:
      serviceAccountName: accounts
      containers:
      - name: accounts
        image: hashicorp/http-echo:1.0
        args: ["-text=accounts", "-listen=:8080"]
        ports:
        - containerPort: 8080
EOF

cat > /root/mesh-lab/apps/accounts/service.yaml << 'EOF'
apiVersion: v1
kind: Service
metadata:
  name: accounts
  namespace: accounts
spec:
  selector:
    app: accounts
  ports:
  - port: 8080
    targetPort: 8080
EOF

cat > /root/mesh-lab/README.md << 'EOF'
# Mesh Lab â€” Istio Ambient Multi-Cluster GitOps
EOF
