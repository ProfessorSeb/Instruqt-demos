#!/bin/bash
set -euxo pipefail

export CTX_CLUSTER1=k3d-cluster-1
export CTX_CLUSTER2=k3d-cluster-2

# Check Telemetry CR exists
for ctx in $CTX_CLUSTER1 $CTX_CLUSTER2; do
  kubectl --context=$ctx get telemetry -n accounts accounts-telemetry || {
    fail-message "Telemetry resource 'accounts-telemetry' not found in accounts namespace on $ctx"
    exit 1
  }
done

# Check GitOps directory structure
for dir in /root/mesh-lab/base /root/mesh-lab/clusters/cluster-1 /root/mesh-lab/clusters/cluster-2 /root/mesh-lab/apps/accounts; do
  if [ ! -d "$dir" ]; then
    fail-message "Directory $dir not found. Create the GitOps structure under /root/mesh-lab/"
    exit 1
  fi
done

if [ ! -f /root/mesh-lab/base/kustomization.yaml ]; then
  fail-message "Missing /root/mesh-lab/base/kustomization.yaml"
  exit 1
fi

echo "Telemetry and GitOps structure verified! Track complete!"
