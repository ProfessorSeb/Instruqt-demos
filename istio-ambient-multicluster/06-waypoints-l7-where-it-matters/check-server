#!/bin/bash
set -euxo pipefail

export CTX_CLUSTER1=k3d-cluster-1
export CTX_CLUSTER2=k3d-cluster-2

# Check waypoint pods are running in both clusters
for ctx in $CTX_CLUSTER1 $CTX_CLUSTER2; do
  WAYPOINT_COUNT=$(kubectl --context=$ctx get pods -n accounts -l gateway.istio.io/managed=istio.io-mesh-controller --no-headers 2>/dev/null | grep -c Running || echo "0")
  if [ "$WAYPOINT_COUNT" -lt 1 ]; then
    fail-message "No waypoint pod running in accounts namespace on $ctx. Run: istioctl waypoint apply -n accounts --enroll-namespace --context=$ctx"
    exit 1
  fi
done

echo "Waypoints verified!"
