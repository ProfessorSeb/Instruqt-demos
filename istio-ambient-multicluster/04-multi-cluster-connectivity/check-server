#!/bin/bash
set -euxo pipefail

export CTX_CLUSTER1=k3d-cluster-1
export CTX_CLUSTER2=k3d-cluster-2

# Check results file exists
if [ ! -f /root/multicluster-results.txt ]; then
  fail-message "Please save the load-balancing results to /root/multicluster-results.txt"
  exit 1
fi

# Verify the file has content
LINES=$(wc -l < /root/multicluster-results.txt)
if [ "$LINES" -lt 5 ]; then
  fail-message "Results file should contain at least 5 lines of output. Run the 10-iteration curl loop."
  exit 1
fi

# Test that cross-cluster connectivity works
RESULT=$(kubectl --context=$CTX_CLUSTER1 exec -n finance deploy/curl -- curl -s --max-time 10 accounts.accounts.svc.cluster.local:8080 2>/dev/null || true)
if [ -z "$RESULT" ]; then
  fail-message "Cross-cluster connectivity not working from cluster-1"
  exit 1
fi

echo "Multi-cluster connectivity verified!"
