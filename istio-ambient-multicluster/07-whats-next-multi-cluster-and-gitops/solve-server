#!/bin/bash
set -euxo pipefail

mkdir -p /root/mesh-lab/{base,overlays/{dev,staging,prod},policies,telemetry,waypoints}

cat > /root/mesh-lab/base/kustomization.yaml << 'EOF'
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
- namespace-finance.yaml
- namespace-accounts.yaml
EOF

cat > /root/mesh-lab/base/namespace-finance.yaml << 'EOF'
apiVersion: v1
kind: Namespace
metadata:
  name: finance
  labels:
    istio.io/dataplane-mode: ambient
EOF

cat > /root/mesh-lab/base/namespace-accounts.yaml << 'EOF'
apiVersion: v1
kind: Namespace
metadata:
  name: accounts
  labels:
    istio.io/dataplane-mode: ambient
EOF

cat > /root/mesh-lab/policies/deny-all.yaml << 'EOF'
apiVersion: security.istio.io/v1
kind: AuthorizationPolicy
metadata:
  name: deny-all
  namespace: accounts
spec: {}
EOF

cat > /root/mesh-lab/policies/allow-finance.yaml << 'EOF'
apiVersion: security.istio.io/v1
kind: AuthorizationPolicy
metadata:
  name: allow-finance
  namespace: accounts
spec:
  action: ALLOW
  rules:
  - from:
    - source:
        namespaces: ["finance"]
EOF

cat > /root/mesh-lab/telemetry/accounts-telemetry.yaml << 'EOF'
apiVersion: telemetry.istio.io/v1
kind: Telemetry
metadata:
  name: accounts-telemetry
  namespace: accounts
spec:
  metrics:
  - providers:
    - name: prometheus
    overrides:
    - match:
        metric: REQUEST_COUNT
        mode: SERVER
      tagOverrides:
        error_type:
          operation: UPSERT
          value: "response.code >= 500 ? 'server_error' : response.code >= 400 ? 'client_error' : 'none'"
EOF

cat > /root/mesh-lab/MULTI-CLUSTER-ROADMAP.md << 'MEOF'
# Multi-Cluster Ambient Mesh Roadmap

## Prerequisites
1. Shared root CA across clusters
2. Network connectivity between cluster nodes (or east-west gateways)
3. Unique cluster names in the mesh

## Steps
1. Generate shared CA certificates
2. Install Istio ambient on each cluster with multi-cluster config
3. Deploy east-west gateways
4. Exchange remote secrets
5. Verify cross-cluster service discovery
MEOF
