#!/bin/bash
set -euxo pipefail

# Generate traffic
pkill -f "port-forward.*ai-gateway" || true
kubectl port-forward -n agentgateway-system svc/ai-gateway 8080:8080 &
sleep 3

for i in $(seq 1 5); do
  curl -s http://localhost:8080/openai/v1/chat/completions \
    -H "Content-Type: application/json" \
    -d '{
      "model": "gpt-4o-mini",
      "messages": [{"role": "user", "content": "Count to 3"}],
      "max_tokens": 20
    }' | jq -r '.choices[0].message.content' 2>/dev/null || true
done

# Check logs
kubectl logs -n agentgateway-system -l app.kubernetes.io/name=agentgateway-proxy --tail=20 || true

# Check metrics
AG_POD=$(kubectl get pods -n agentgateway-system -l app.kubernetes.io/name=agentgateway-proxy -o jsonpath='{.items[0].metadata.name}') || true
kubectl port-forward -n agentgateway-system $AG_POD 9091:9091 &
sleep 2
curl -s http://localhost:9091/metrics | grep -i "agentgateway\|llm\|ai_\|envoy" | head -30 || true
