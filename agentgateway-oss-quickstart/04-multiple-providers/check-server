#!/bin/bash
set -euxo pipefail

if ! kubectl get secret anthropic-api-key -n agentgateway-system &>/dev/null; then
  fail-message "The 'anthropic-api-key' secret was not found."
  exit 1
fi

if ! kubectl get agentgatewaybackend anthropic-backend -n agentgateway-system &>/dev/null; then
  fail-message "The 'anthropic-backend' AgentgatewayBackend was not found."
  exit 1
fi

if ! kubectl get httproute anthropic-route -n agentgateway-system &>/dev/null; then
  fail-message "The 'anthropic-route' HTTPRoute was not found."
  exit 1
fi

BACKEND_COUNT=$(kubectl get agentgatewaybackend -n agentgateway-system --no-headers 2>/dev/null | wc -l)
if [ "$BACKEND_COUNT" -lt 2 ]; then
  fail-message "Expected at least 2 backends but found $BACKEND_COUNT."
  exit 1
fi

echo "Multi-provider routing is configured!"
