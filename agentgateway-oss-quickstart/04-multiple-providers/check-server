#!/bin/bash
set -euxo pipefail

if ! kubectl get agentgatewaybackend openai-gpt4o-backend -n agentgateway-system &>/dev/null; then
  fail-message "The 'openai-gpt4o-backend' AgentgatewayBackend was not found. Create a second OpenAI backend for GPT-4o."
  exit 1
fi

BACKEND_COUNT=$(kubectl get agentgatewaybackend -n agentgateway-system --no-headers 2>/dev/null | wc -l)
if [ "$BACKEND_COUNT" -lt 2 ]; then
  fail-message "Expected at least 2 backends but found $BACKEND_COUNT."
  exit 1
fi

# Check that the route has multiple backendRefs (weighted)
WEIGHT_COUNT=$(kubectl get httproute openai-route -n agentgateway-system -o json | jq '.spec.rules[0].backendRefs | length')
if [ "$WEIGHT_COUNT" -lt 2 ]; then
  fail-message "The 'openai-route' HTTPRoute should have at least 2 weighted backendRefs for load balancing."
  exit 1
fi

echo "Model load balancing is configured!"
