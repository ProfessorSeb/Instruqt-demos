#!/bin/bash
set -euxo pipefail

export KUBECONFIG=/etc/rancher/k3s/k3s.yaml

# Check Anthropic secret
if ! kubectl get secret anthropic-api-key -n agentgateway-system &>/dev/null; then
  fail-message "The 'anthropic-api-key' secret was not found. Create it with: kubectl create secret generic anthropic-api-key --namespace agentgateway-system --from-literal=api-key=\"sk-ant-demo-placeholder-key\""
  exit 1
fi

# Check Anthropic backend
if ! kubectl get backend anthropic-backend -n agentgateway-system &>/dev/null; then
  fail-message "The 'anthropic-backend' Backend was not found. Please create it as described in the instructions."
  exit 1
fi

# Check Anthropic route
if ! kubectl get httproute anthropic-route -n agentgateway-system &>/dev/null; then
  fail-message "The 'anthropic-route' HTTPRoute was not found. Please create it as described in the instructions."
  exit 1
fi

# Verify we now have 2 backends
BACKEND_COUNT=$(kubectl get backend -n agentgateway-system --no-headers 2>/dev/null | wc -l)
if [ "$BACKEND_COUNT" -lt 2 ]; then
  fail-message "Expected at least 2 backends (openai-backend and anthropic-backend) but found $BACKEND_COUNT. Check: kubectl get backend -n agentgateway-system"
  exit 1
fi

echo "Multi-provider routing is configured!"
