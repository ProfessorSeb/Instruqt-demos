#!/bin/bash
set -euxo pipefail
# Verify cluster
kubectl cluster-info
kubectl get nodes

# Verify Gateway API CRDs
kubectl get crds | grep gateway

# Install AgentGateway CRDs
helm install agentgateway-crds oci://ghcr.io/kgateway-dev/charts/agentgateway-crds \
  --version v2.2.0 \
  --namespace agentgateway-system \
  --create-namespace \
  --wait

# Install AgentGateway control plane
helm install agentgateway oci://ghcr.io/kgateway-dev/charts/agentgateway \
  --version v2.2.0 \
  --namespace agentgateway-system \
  --wait --timeout 120s

# Create OpenAI secret if key is available
if [ -f /root/.openai-api-key ]; then
  OPENAI_API_KEY=$(cat /root/.openai-api-key)
  kubectl create secret generic openai-secret -n agentgateway-system \
    --from-literal="Authorization=Bearer $OPENAI_API_KEY" \
    --dry-run=client -oyaml | kubectl apply -f -
fi

# Verify
kubectl get pods -n agentgateway-system
kubectl get gatewayclass
