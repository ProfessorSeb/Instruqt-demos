#!/bin/bash
set -euxo pipefail

# Check AgentGateway namespace exists
if ! kubectl get namespace agentgateway-system &>/dev/null; then
  fail-message "The 'agentgateway-system' namespace doesn't exist. Did you install the AgentGateway Helm charts? Start with: helm install agentgateway-crds agentgateway/agentgateway-crds --version 2.1.0 --namespace agentgateway-system --create-namespace --wait"
  exit 1
fi

# Check CRDs are installed
if ! helm list -n agentgateway-system | grep -q agentgateway-crds; then
  fail-message "The agentgateway-crds Helm release is not found. Please install it first: helm install agentgateway-crds agentgateway/agentgateway-crds --version 2.1.0 --namespace agentgateway-system --create-namespace --wait"
  exit 1
fi

# Check control plane is installed
if ! helm list -n agentgateway-system | grep -q "agentgateway[^-]"; then
  fail-message "The agentgateway control plane Helm release is not found. Please install it: helm install agentgateway agentgateway/agentgateway --version 2.1.0 --namespace agentgateway-system --wait"
  exit 1
fi

# Check pods are running
NOT_RUNNING=$(kubectl get pods -n agentgateway-system --no-headers 2>/dev/null | grep -v Running | grep -v Completed || true)
if [ -n "$NOT_RUNNING" ]; then
  fail-message "Some AgentGateway pods are not in Running state. Run 'kubectl get pods -n agentgateway-system' to check their status. You may need to wait a moment for them to start."
  exit 1
fi

# Check GatewayClass exists
if ! kubectl get gatewayclass agentgateway &>/dev/null; then
  fail-message "The 'agentgateway' GatewayClass was not found. This should be created automatically by the Helm install. Try: kubectl get gatewayclass"
  exit 1
fi

echo "AgentGateway is installed and running!"
