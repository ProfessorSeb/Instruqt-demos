#!/bin/bash
set -euxo pipefail

# Wait for the Instruqt bootstrap to finish
until [ -f /opt/instruqt/bootstrap/host-bootstrap-completed ]; do
  echo "Waiting for Instruqt bootstrap..."
  sleep 2
done

echo "=== Installing k3s ==="
curl -sfL https://get.k3s.io | INSTALL_K3S_EXEC="--disable=traefik" sh -

# Wait for k3s to be ready
export KUBECONFIG=/etc/rancher/k3s/k3s.yaml
until kubectl get nodes 2>/dev/null | grep -q ' Ready'; do
  echo "Waiting for k3s node to be Ready..."
  sleep 3
done

echo "=== Configuring shell environment ==="
cat >> /root/.bashrc << 'BASHEOF'
export KUBECONFIG=/etc/rancher/k3s/k3s.yaml
alias k=kubectl
source <(kubectl completion bash)
complete -o default -F __start_kubectl k
BASHEOF

echo "=== Installing Helm ==="
curl -fsSL https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash

echo "=== Installing jq ==="
apt-get update -qq && apt-get install -y -qq jq

echo "=== Installing Gateway API CRDs ==="
kubectl apply -f https://github.com/kubernetes-sigs/gateway-api/releases/download/v1.2.0/standard-install.yaml

echo "=== Adding AgentGateway Helm repo ==="
helm repo add agentgateway https://solo-io.github.io/agentgateway
helm repo update

echo "=== Track setup complete ==="
