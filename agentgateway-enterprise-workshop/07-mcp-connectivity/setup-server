#!/bin/bash
set -euxo pipefail

# Clean up previous policies from rate limiting challenge
kubectl delete enterpriseagentgatewaypolicy -n enterprise-agentgateway global-request-rate-limit 2>/dev/null || true
kubectl delete ratelimitconfig -n enterprise-agentgateway global-request-rate-limit 2>/dev/null || true

# Ensure Node.js 22+ is installed (required for MCP Inspector CLI)
if ! command -v node &>/dev/null || [[ $(node -v | sed 's/v//;s/\..*//' ) -lt 22 ]]; then
  curl -fsSL https://deb.nodesource.com/setup_22.x | bash -
  apt-get install -y nodejs
fi

echo "Node.js version: $(node -v)"

# Pre-cache MCP Inspector so npx doesn't delay during the lab
npx -y @modelcontextprotocol/inspector --help 2>/dev/null || true

# Source environment for GATEWAY_IP
source /root/.bashrc

if [ -z "${GATEWAY_IP:-}" ]; then
  export GATEWAY_IP=$(kubectl get svc -n enterprise-agentgateway --selector=gateway.networking.k8s.io/gateway-name=agentgateway -o jsonpath='{.items[*].status.loadBalancer.ingress[0].ip}{.items[*].status.loadBalancer.ingress[0].hostname}')
  echo "export GATEWAY_IP=$GATEWAY_IP" >> /root/.bashrc
fi

echo "GATEWAY_IP: $GATEWAY_IP"

# Create MCP Inspector config (used by all steps â€” auth is passed via --header flag)
cat > /root/mcp-inspector-config.json <<IEOF
{
  "mcpServers": {
    "agentgateway": {
      "type": "streamable-http",
      "url": "http://${GATEWAY_IP}:8080/mcp"
    }
  }
}
IEOF

echo "MCP Inspector config created: /root/mcp-inspector-config.json"
echo "Challenge 7 setup complete"
