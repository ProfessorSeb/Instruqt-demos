#!/bin/bash

# Wait for instruqt bootstrap
until [ -f /opt/instruqt/bootstrap/host-bootstrap-completed ]; do
  sleep 1
done

set -euxo pipefail

set-workdir /root

# Shell conveniences
cat >> ~/.bashrc << 'EOF'
alias k=kubectl
complete -F __start_kubectl k
source /etc/bash_completion
EOF

# Start k3d cluster (pre-installed in image)
if command -v k3d >/dev/null 2>&1; then
  k3d cluster start my-k8s-cluster 2>/dev/null || \
  k3d cluster create my-k8s-cluster --wait
fi

# Wait for cluster to be ready
kubectl wait --for=condition=Ready nodes --all --timeout=120s

echo "=== Installing Gateway API CRDs (v1.4.0) ==="
kubectl apply -f https://github.com/kubernetes-sigs/gateway-api/releases/download/v1.4.0/standard-install.yaml

echo "=== Installing AgentGateway CRDs ==="
helm upgrade -i --create-namespace \
  --namespace agentgateway-system \
  --version v2.2.0 agentgateway-crds oci://ghcr.io/kgateway-dev/charts/agentgateway-crds

echo "=== Installing AgentGateway ==="
helm upgrade -i -n agentgateway-system agentgateway oci://ghcr.io/kgateway-dev/charts/agentgateway \
  --version v2.2.0 --wait

# Wait for agentgateway deployment
kubectl -n agentgateway-system wait --for=condition=Available deployment --all --timeout=120s

echo "=== Setting up AgentGateway Proxy ==="
kubectl apply -f- <<EOF
apiVersion: gateway.networking.k8s.io/v1
kind: Gateway
metadata:
  name: agentgateway-proxy
  namespace: agentgateway-system
spec:
  gatewayClassName: agentgateway
  listeners:
  - name: http
    port: 8080
    protocol: HTTP
EOF

# Wait for gateway proxy pod
sleep 10
kubectl -n agentgateway-system wait --for=condition=Available deployment/agentgateway-proxy --timeout=120s

# Install Node.js for MCP Inspector (nvm is pre-installed in image)
export NVM_DIR="/root/.nvm"
[ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"
if command -v node >/dev/null 2>&1; then
  echo "Node.js already available: $(node --version)"
else
  nvm install 20 || true
fi

# Set up port-forward for the agentgateway proxy as a systemd service
cat <<SVCEOF >/etc/systemd/system/agentgateway-proxy.service
[Unit]
Description=AgentGateway Proxy Port Forward
After=cloud-final.service multi-user.target
[Service]
Restart=always
RestartSec=5s
Environment="KUBECONFIG=/root/.kube/config"
ExecStart=/usr/local/bin/kubectl -n agentgateway-system port-forward deployment/agentgateway-proxy 8080:8080 --address 0.0.0.0
[Install]
WantedBy=multi-user.target
SVCEOF
systemctl daemon-reload
systemctl enable agentgateway-proxy
systemctl start agentgateway-proxy

echo "=== Creating MCP namespace ==="
kubectl create namespace mcp || true

echo "=== Pre-pulling MCP server image into k3d ==="
# Import the image into k3d so challenges don't wait for pulls
docker pull ghcr.io/peterj/mcp-website-fetcher:main || true
k3d image import ghcr.io/peterj/mcp-website-fetcher:main -c my-k8s-cluster || true

echo "=== Track setup complete ==="
