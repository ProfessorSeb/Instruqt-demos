#!/bin/bash
set -euxo pipefail

# Ensure previous resources exist
kubectl -n agentgateway-system get httproute mcp-route

# Deploy Keycloak
kubectl create namespace keycloak --dry-run=client -o yaml | kubectl apply -f -

cat > /tmp/keycloak.yaml << 'YAML'
apiVersion: apps/v1
kind: Deployment
metadata:
  name: keycloak
  namespace: keycloak
spec:
  replicas: 1
  selector:
    matchLabels:
      app: keycloak
  template:
    metadata:
      labels:
        app: keycloak
    spec:
      containers:
      - name: keycloak
        image: quay.io/keycloak/keycloak:26.0
        args: ["start-dev"]
        env:
        - name: KEYCLOAK_ADMIN
          value: admin
        - name: KEYCLOAK_ADMIN_PASSWORD
          value: admin
        - name: KC_HTTP_PORT
          value: "8080"
        ports:
        - containerPort: 8080
        readinessProbe:
          httpGet:
            path: /realms/master
            port: 8080
          initialDelaySeconds: 30
          periodSeconds: 10
---
apiVersion: v1
kind: Service
metadata:
  name: keycloak
  namespace: keycloak
spec:
  selector:
    app: keycloak
  ports:
  - port: 8080
    targetPort: 8080
YAML

kubectl apply -f /tmp/keycloak.yaml
echo "Waiting for Keycloak to be ready..."
kubectl -n keycloak wait --for=condition=Ready pod -l app=keycloak --timeout=300s

# Port-forward Keycloak
kubectl -n keycloak port-forward svc/keycloak 8180:8080 &
sleep 5

# Get admin token
ADMIN_TOKEN=$(curl -s --retry 5 --retry-delay 3 http://localhost:8180/realms/master/protocol/openid-connect/token \
  -d "client_id=admin-cli" \
  -d "username=admin" \
  -d "password=admin" \
  -d "grant_type=password" | jq -r '.access_token')

# Create agentgateway realm
curl -s -X POST http://localhost:8180/admin/realms \
  -H "Authorization: Bearer $ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"realm": "agentgateway", "enabled": true}'

# Create client
curl -s -X POST http://localhost:8180/admin/realms/agentgateway/clients \
  -H "Authorization: Bearer $ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "clientId": "mcp-agent",
    "enabled": true,
    "clientAuthenticatorType": "client-secret",
    "secret": "agent-secret-123",
    "directAccessGrantsEnabled": true,
    "serviceAccountsEnabled": true
  }'

# Create test user
curl -s -X POST http://localhost:8180/admin/realms/agentgateway/users \
  -H "Authorization: Bearer $ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "username": "agent-user",
    "enabled": true,
    "credentials": [{"type": "password", "value": "agent-pass", "temporary": false}]
  }'

# Kill the port-forward
kill %1 2>/dev/null || true

echo "Challenge 6 setup complete â€” Keycloak is running and configured"
