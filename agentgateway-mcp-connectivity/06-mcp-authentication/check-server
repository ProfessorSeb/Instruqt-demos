#!/bin/bash
set -euxo pipefail

# Check Keycloak is running
if ! kubectl -n keycloak get deployment keycloak &>/dev/null; then
  fail-message "Keycloak deployment was not found in the 'keycloak' namespace."
  exit 1
fi

kubectl -n keycloak wait --for=condition=Ready pod -l app=keycloak --timeout=30s || {
  fail-message "Keycloak pod is not ready yet. It may take a minute to start. Try again."
  exit 1
}

# Check Keycloak AgentgatewayBackend exists
if ! kubectl -n keycloak get agentgatewaybackend keycloak &>/dev/null; then
  fail-message "The 'keycloak' AgentgatewayBackend was not found in the keycloak namespace. Please create it as described â€” the auth policy needs it to fetch JWKS keys."
  exit 1
fi

# Check auth policy exists
if ! kubectl -n agentgateway-system get agentgatewaypolicy mcp-oauth-auth &>/dev/null; then
  fail-message "The mcp-oauth-auth AgentgatewayPolicy was not found. Please create it as described."
  exit 1
fi

# Verify it has MCP authentication configured
if ! kubectl -n agentgateway-system get agentgatewaypolicy mcp-oauth-auth -o yaml | grep -q "authentication"; then
  fail-message "The mcp-oauth-auth policy doesn't have MCP authentication configured. Check the spec."
  exit 1
fi

echo "MCP authentication is configured correctly! Congratulations on completing the track!"
