#!/bin/bash
set -euxo pipefail

# Deploy Keycloak
cat > /root/keycloak.yaml << 'YAML'
apiVersion: v1
kind: Namespace
metadata:
  name: keycloak
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: keycloak
  namespace: keycloak
spec:
  replicas: 1
  selector:
    matchLabels:
      app: keycloak
  template:
    metadata:
      labels:
        app: keycloak
    spec:
      containers:
      - name: keycloak
        image: quay.io/keycloak/keycloak:24.0
        args: ["start-dev"]
        env:
        - name: KEYCLOAK_ADMIN
          value: admin
        - name: KEYCLOAK_ADMIN_PASSWORD
          value: admin
        - name: KC_HTTP_PORT
          value: "8180"
        ports:
        - containerPort: 8180
        readinessProbe:
          httpGet:
            path: /realms/master
            port: 8180
          initialDelaySeconds: 30
          periodSeconds: 10
---
apiVersion: v1
kind: Service
metadata:
  name: keycloak
  namespace: keycloak
spec:
  selector:
    app: keycloak
  ports:
  - port: 8180
    targetPort: 8180
YAML
kubectl apply -f /root/keycloak.yaml
kubectl -n keycloak wait --for=condition=Ready pod -l app=keycloak --timeout=180s

# Configure Keycloak
kubectl -n keycloak port-forward svc/keycloak 8180:8180 &
sleep 5

ADMIN_TOKEN=$(curl -s http://localhost:8180/realms/master/protocol/openid-connect/token \
  -d "client_id=admin-cli" \
  -d "username=admin" \
  -d "password=admin" \
  -d "grant_type=password" | jq -r '.access_token')

curl -s -X POST http://localhost:8180/admin/realms \
  -H "Authorization: Bearer $ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"realm": "agentgateway", "enabled": true}'

curl -s -X POST http://localhost:8180/admin/realms/agentgateway/clients \
  -H "Authorization: Bearer $ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"clientId": "mcp-agent", "enabled": true, "clientAuthenticatorType": "client-secret", "secret": "agent-secret-123", "directAccessGrantsEnabled": true, "serviceAccountsEnabled": true}'

curl -s -X POST http://localhost:8180/admin/realms/agentgateway/users \
  -H "Authorization: Bearer $ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"username": "agent-user", "enabled": true, "credentials": [{"type": "password", "value": "agent-pass", "temporary": false}]}'

# Create auth policy
cat > /root/mcp-auth-policy.yaml << 'YAML'
apiVersion: agentgateway.dev/v1alpha1
kind: AgentgatewayPolicy
metadata:
  name: mcp-oauth-auth
  namespace: agentgateway-system
spec:
  targetRefs:
  - kind: HTTPRoute
    name: mcp-route
  auth:
    oauth:
      issuerUrl: http://keycloak.keycloak.svc.cluster.local:8180/realms/agentgateway
      clientId: mcp-agent
YAML
kubectl apply -f /root/mcp-auth-policy.yaml
