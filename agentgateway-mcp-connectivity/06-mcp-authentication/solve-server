#!/bin/bash
set -euxo pipefail

# Keycloak should already be deployed by setup-server
# Create the AgentgatewayBackend for Keycloak JWKS
kubectl apply -f- <<EOF
apiVersion: agentgateway.dev/v1alpha1
kind: AgentgatewayBackend
metadata:
  name: keycloak
  namespace: keycloak
spec:
  static:
    host: keycloak.keycloak.svc.cluster.local
    port: 8080
EOF

# Create the auth policy
cat > /root/mcp-auth-policy.yaml << 'YAML'
apiVersion: agentgateway.dev/v1alpha1
kind: AgentgatewayPolicy
metadata:
  name: mcp-oauth-auth
  namespace: agentgateway-system
spec:
  targetRefs:
  - group: gateway.networking.k8s.io
    kind: HTTPRoute
    name: mcp-route
  backend:
    mcp:
      authentication:
        issuer: "http://keycloak.keycloak.svc.cluster.local:8080/realms/agentgateway"
        audiences:
          - "mcp-agent"
        jwks:
          backendRef:
            name: keycloak
            namespace: keycloak
            port: 8080
          jwksPath: "/realms/agentgateway/protocol/openid-connect/certs"
        mode: Strict
        provider: Keycloak
        resourceMetadata:
          resource: "http://mcp-server.default.svc.cluster.local"
          scopesSupported:
            - "openid"
          bearerMethodsSupported:
            - "header"
YAML
kubectl apply -f /root/mcp-auth-policy.yaml
