#!/bin/bash
set -euxo pipefail

# Check MCP server is running
if ! kubectl -n mcp get deployment fetch-mcp-server &>/dev/null; then
  fail-message "The fetch-mcp-server deployment was not found in the 'mcp' namespace. Please deploy it as described in the instructions."
  exit 1
fi

# Check Gateway exists
if ! kubectl -n agentgateway-system get gateway mcp-gateway &>/dev/null; then
  fail-message "The mcp-gateway Gateway resource was not found. Please create it as described."
  exit 1
fi

# Check AgentgatewayBackend exists
if ! kubectl -n agentgateway-system get agentgatewaybackend fetch-mcp &>/dev/null; then
  fail-message "The fetch-mcp AgentgatewayBackend was not found. Please create it as described."
  exit 1
fi

# Check HTTPRoute exists
if ! kubectl -n agentgateway-system get httproute mcp-route &>/dev/null; then
  fail-message "The mcp-route HTTPRoute was not found. Please create it as described."
  exit 1
fi

# Check MCP server pod is running
kubectl -n mcp wait --for=condition=Ready pod -l app=fetch-mcp-server --timeout=30s || {
  fail-message "The fetch-mcp-server pod is not ready yet. Wait a moment and try again."
  exit 1
}

echo "Static MCP routing is configured correctly!"
