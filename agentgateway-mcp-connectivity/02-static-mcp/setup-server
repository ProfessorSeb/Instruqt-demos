#!/bin/bash
set -euxo pipefail

# Source nvm for npx
export NVM_DIR="/root/.nvm"
[ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"

# Run MCP Inspector with UI on 6280 and Proxy on 6281 (internal only)
# Nginx on port 6274 (Instruqt tab) serves both through a single origin
cat <<'SVCEOF' > /etc/systemd/system/mcp-inspector.service
[Unit]
Description=MCP Inspector
After=network.target
[Service]
Restart=always
RestartSec=3s
Environment="NVM_DIR=/root/.nvm"
Environment="DANGEROUSLY_OMIT_AUTH=true"
Environment="CLIENT_PORT=6280"
Environment="SERVER_PORT=6281"
Environment="HOST=127.0.0.1"
ExecStart=/bin/bash -c 'source /root/.nvm/nvm.sh && npx -y @modelcontextprotocol/inspector'
[Install]
WantedBy=multi-user.target
SVCEOF

# Install nginx if not present
which nginx >/dev/null 2>&1 || apt-get install -y nginx >/dev/null 2>&1

# Nginx: single port 6274
# - /proxy/* → inspector proxy (6281)
# - /* → inspector UI (6280)
# - Inject JS via sub_filter to auto-set MCP_PROXY_FULL_ADDRESS on first load
cat <<'NGINX' > /etc/nginx/sites-available/mcp-inspector
server {
    listen 6274;
    listen [::]:6274;

    # Proxy API requests → inspector proxy server (6281)
    location /proxy/ {
        rewrite ^/proxy(/.*)$ $1 break;
        proxy_pass http://127.0.0.1:6281;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_read_timeout 300;
        proxy_send_timeout 300;
    }

    # Inspector UI → 6280
    # Inject script to redirect with MCP_PROXY_FULL_ADDRESS if missing
    location / {
        proxy_pass http://127.0.0.1:6280;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header Accept-Encoding "";

        sub_filter '</head>' '<script>if(!new URLSearchParams(location.search).has("MCP_PROXY_FULL_ADDRESS")){location.replace("/?MCP_PROXY_FULL_ADDRESS="+encodeURIComponent(location.origin+"/proxy"));}</script></head>';
        sub_filter_once on;
        sub_filter_types text/html;
    }
}
NGINX

ln -sf /etc/nginx/sites-available/mcp-inspector /etc/nginx/sites-enabled/
rm -f /etc/nginx/sites-enabled/default

systemctl daemon-reload
systemctl enable mcp-inspector
systemctl start mcp-inspector

# Wait for inspector to be up
for i in $(seq 1 30); do
  if ss -tlnp | grep -q ':6280' && ss -tlnp | grep -q ':6281'; then
    echo "MCP Inspector is ready"
    break
  fi
  sleep 1
done

# Start nginx on port 6274
systemctl restart nginx

# Ensure port-forward is running (systemd service from track setup)
systemctl restart agentgateway-proxy || true

kubectl wait --for=condition=Ready nodes --all --timeout=120s

echo "Challenge 2 setup complete"
