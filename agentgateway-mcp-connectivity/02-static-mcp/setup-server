#!/bin/bash
set -euxo pipefail

# Source nvm for npx
export NVM_DIR="/root/.nvm"
[ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"

# Create MCP Inspector as a systemd service so it persists across challenges
cat <<'SVCEOF' > /etc/systemd/system/mcp-inspector.service
[Unit]
Description=MCP Inspector
After=network.target
[Service]
Restart=always
RestartSec=3s
Environment="NVM_DIR=/root/.nvm"
Environment="DANGEROUSLY_OMIT_AUTH=true"
Environment="CLIENT_PORT=6274"
Environment="HOST=0.0.0.0"
ExecStart=/bin/bash -c 'source /root/.nvm/nvm.sh && npx -y @modelcontextprotocol/inspector'
[Install]
WantedBy=multi-user.target
SVCEOF
systemctl daemon-reload
systemctl enable mcp-inspector
systemctl start mcp-inspector

# Wait for inspector to be listening
for i in $(seq 1 30); do
  if ss -tlnp | grep -q ':6274'; then
    echo "MCP Inspector is ready on port 6274"
    break
  fi
  sleep 1
done

# Ensure port-forward is running (systemd service from track setup)
systemctl restart agentgateway-proxy || true

kubectl wait --for=condition=Ready nodes --all --timeout=120s

echo "Challenge 2 setup complete"
