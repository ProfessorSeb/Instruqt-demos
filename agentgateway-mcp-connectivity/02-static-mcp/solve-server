#!/bin/bash
set -euxo pipefail

# Deploy MCP website fetcher server
cat > /root/mcp-website-fetcher.yaml << 'YAML'
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mcp-website-fetcher
  namespace: default
spec:
  replicas: 1
  selector:
    matchLabels:
      app: mcp-website-fetcher
  template:
    metadata:
      labels:
        app: mcp-website-fetcher
    spec:
      containers:
      - name: server
        image: ghcr.io/peterj/mcp-website-fetcher:main
        ports:
        - containerPort: 8000
---
apiVersion: v1
kind: Service
metadata:
  name: mcp-website-fetcher
  namespace: default
spec:
  selector:
    app: mcp-website-fetcher
  ports:
  - port: 80
    targetPort: 8000
    appProtocol: kgateway.dev/mcp
YAML
kubectl apply -f /root/mcp-website-fetcher.yaml
kubectl wait --for=condition=Ready pod -l app=mcp-website-fetcher --timeout=120s

# Create Backend
cat > /root/mcp-backend.yaml << 'YAML'
apiVersion: agentgateway.dev/v1alpha1
kind: AgentgatewayBackend
metadata:
  name: mcp-backend
  namespace: agentgateway-system
spec:
  mcp:
    targets:
    - name: mcp-target
      static:
        host: mcp-website-fetcher.default.svc.cluster.local
        port: 80
        protocol: SSE
YAML
kubectl apply -f /root/mcp-backend.yaml

# Create Route
cat > /root/mcp-route.yaml << 'YAML'
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: mcp-route
  namespace: agentgateway-system
spec:
  parentRefs:
  - name: agentgateway-proxy
    namespace: agentgateway-system
  rules:
  - matches:
    - path:
        type: PathPrefix
        value: /mcp
    backendRefs:
    - name: mcp-backend
      group: agentgateway.dev
      kind: AgentgatewayBackend
YAML
kubectl apply -f /root/mcp-route.yaml
