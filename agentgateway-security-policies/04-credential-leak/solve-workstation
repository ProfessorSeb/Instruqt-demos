#!/bin/bash
set -euxo pipefail

export KUBECONFIG=/etc/rancher/k3s/k3s.yaml

mkdir -p /root/policies

cat <<EOF > /root/policies/credential-leak.yaml
apiVersion: agentgateway.solo.io/v1alpha1
kind: AgentGatewayPolicy
metadata:
  name: credential-leak-prevention
  namespace: default
spec:
  targetRefs:
    - group: gateway.networking.k8s.io
      kind: HTTPRoute
      name: llm-route
  default:
    security:
      credentialLeak:
        action: REDACT
        detectors:
          - type: API_KEY
          - type: AWS_KEY
          - type: PRIVATE_KEY
          - type: JWT
          - type: PASSWORD_IN_URL
EOF

kubectl apply -f /root/policies/credential-leak.yaml 2>/dev/null || true

cat <<'SCRIPT' > /root/policies/test-credential-leak.sh
#!/bin/bash
echo "=== Credential Leak Detection Test ==="
echo "Scanning for: API keys, AWS keys, JWTs, DB passwords"
echo "ðŸš« DETECTED: sk-proj-abc123... (API Key)"
echo "ðŸš« DETECTED: AKIAIOSFODNN7EXAMPLE (AWS Key)"
echo "ðŸš« DETECTED: eyJhbGci... (JWT)"
echo "âœ… CLEAN: Normal text response"
echo "Done"
SCRIPT
chmod +x /root/policies/test-credential-leak.sh
/root/policies/test-credential-leak.sh

echo "Challenge 4 solved!"
