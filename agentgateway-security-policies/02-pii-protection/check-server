#!/bin/bash
set -euxo pipefail

# Check that the PII protection policy YAML exists
if [ ! -f /root/policies/pii-protection.yaml ]; then
  fail-message "PII protection policy file not found at /root/policies/pii-protection.yaml. Please create it as shown in the instructions."
  exit 1
fi

# Validate it contains the right content
if ! grep -q "pii" /root/policies/pii-protection.yaml; then
  fail-message "The policy file doesn't contain PII configuration. Check the file content matches the instructions."
  exit 1
fi

if ! grep -q "REDACT" /root/policies/pii-protection.yaml; then
  fail-message "The policy file should have action: REDACT. Check the file content."
  exit 1
fi

if ! grep -q "SSN" /root/policies/pii-protection.yaml; then
  fail-message "The policy should include SSN detector. Check the detectors list."
  exit 1
fi

# Check that the test script exists and was run
if [ ! -f /root/policies/test-pii.sh ]; then
  fail-message "PII test script not found at /root/policies/test-pii.sh. Please create it as shown in the instructions."
  exit 1
fi

echo "Challenge 2 complete!"
