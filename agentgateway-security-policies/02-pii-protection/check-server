#!/bin/bash
set -euxo pipefail

if [ ! -f /root/policies/pii-protection.yaml ]; then
  fail-message "PII protection policy file not found at /root/policies/pii-protection.yaml. Please create it as shown in the instructions."
  exit 1
fi

if ! grep -q "promptGuard" /root/policies/pii-protection.yaml; then
  fail-message "The policy file doesn't contain promptGuard configuration. Check the file content matches the instructions."
  exit 1
fi

if ! grep -q "Reject" /root/policies/pii-protection.yaml; then
  fail-message "The policy should use action: Reject for request-side PII blocking."
  exit 1
fi

if ! grep -q "Ssn\|CreditCard" /root/policies/pii-protection.yaml; then
  fail-message "The policy should include built-in PII matchers (Ssn, CreditCard). Check the builtins list."
  exit 1
fi

# Check it's actually applied to the cluster
if ! kubectl get enterpriseagentgatewaypolicy pii-protection -n default &>/dev/null; then
  fail-message "The pii-protection EnterpriseAgentgatewayPolicy is not applied to the cluster. Run: kubectl apply -f /root/policies/pii-protection.yaml"
  exit 1
fi

echo "Challenge 2 complete!"
