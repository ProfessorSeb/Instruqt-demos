#!/bin/bash
set -euxo pipefail

if [ ! -f /root/policies/comprehensive-security.yaml ]; then
  fail-message "Comprehensive security policy not found at /root/policies/comprehensive-security.yaml. Please create the combined policy as shown in the instructions."
  exit 1
fi

if ! grep -q "promptGuard" /root/policies/comprehensive-security.yaml; then
  fail-message "Comprehensive policy should include promptGuard configuration."
  exit 1
fi

if ! grep -q "Reject" /root/policies/comprehensive-security.yaml; then
  fail-message "Comprehensive policy should include Reject action for request-side protection."
  exit 1
fi

if ! grep -q "Mask" /root/policies/comprehensive-security.yaml; then
  fail-message "Comprehensive policy should include Mask action for response-side protection."
  exit 1
fi

if ! kubectl get enterpriseagentgatewaypolicy comprehensive-security -n default &>/dev/null; then
  fail-message "The comprehensive-security EnterpriseAgentgatewayPolicy is not applied to the cluster. Run: kubectl apply -f /root/policies/comprehensive-security.yaml"
  exit 1
fi

echo "ðŸŽ‰ Track complete! You've built a defense-in-depth security posture for your AI gateway."
