#!/bin/bash
set -euxo pipefail
mkdir -p /root/policies

# Clean up individual policies
kubectl delete enterpriseagentgatewaypolicies --all -n default 2>/dev/null || true

cat <<EOF > /root/policies/comprehensive-security.yaml
apiVersion: enterpriseagentgateway.solo.io/v1alpha1
kind: EnterpriseAgentgatewayPolicy
metadata:
  name: comprehensive-security
  namespace: default
spec:
  targetRefs:
  - group: gateway.networking.k8s.io
    kind: HTTPRoute
    name: llm-route
  backend:
    ai:
      promptGuard:
        request:
        - response:
            message: "ðŸš« Rejected - PII detected in request"
          regex:
            action: Reject
            builtins:
            - CreditCard
            - Ssn
            - PhoneNumber
            - Email
        - response:
            message: "ðŸš« Prompt injection detected â€” request blocked"
          regex:
            action: Reject
            matches:
            - "(?i)ignore.*previous.*instructions"
            - "(?i)you are now (DAN|evil|a system)"
            - "(?i)output.*system.*prompt"
            - "(?i)do anything now"
            - "(?i)forget.*your.*rules"
        response:
        - regex:
            action: Mask
            builtins:
            - CreditCard
            matches:
            - "sk-[a-zA-Z0-9]{20,}"
            - "ghp_[a-zA-Z0-9]{36}"
            - "AKIA[0-9A-Z]{16}"
            - "xoxb-[a-zA-Z0-9-]+"
EOF

kubectl apply -f /root/policies/comprehensive-security.yaml
