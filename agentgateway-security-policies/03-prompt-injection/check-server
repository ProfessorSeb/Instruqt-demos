#!/bin/bash
set -euxo pipefail

if [ ! -f /root/policies/prompt-injection.yaml ]; then
  fail-message "Prompt injection policy not found at /root/policies/prompt-injection.yaml. Please create it as shown in the instructions."
  exit 1
fi

if ! grep -q "promptGuard" /root/policies/prompt-injection.yaml; then
  fail-message "Policy file doesn't contain promptGuard configuration. Check the file content."
  exit 1
fi

if ! grep -q "Reject" /root/policies/prompt-injection.yaml; then
  fail-message "Policy should use action: Reject to block injection attempts."
  exit 1
fi

if ! kubectl get enterpriseagentgatewaypolicy prompt-injection-guard -n default &>/dev/null; then
  fail-message "The prompt-injection-guard EnterpriseAgentgatewayPolicy is not applied to the cluster. Run: kubectl apply -f /root/policies/prompt-injection.yaml"
  exit 1
fi

echo "Challenge 3 complete!"
