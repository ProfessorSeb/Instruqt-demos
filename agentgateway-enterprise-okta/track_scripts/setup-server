#!/bin/bash
until [ -f /opt/instruqt/bootstrap/host-bootstrap-completed ]; do
  sleep 1
done

set -euxo pipefail
set-workdir /root

# Shell conveniences
cat >> ~/.bashrc << 'BASHEOF'
alias k=kubectl
complete -F __start_kubectl k
source /etc/bash_completion
export NVM_DIR="/root/.nvm"
[ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"
BASHEOF

# Vim config
cat << 'EOF' >> ~/.vimrc
colorscheme koehler
set tabstop=2 softtabstop=2 shiftwidth=2
set number expandtab ruler autoindent smartindent cursorline
syntax enable
filetype plugin indent on
EOF

# Start k3d cluster
if command -v k3d >/dev/null 2>&1; then
  k3d cluster start my-k8s-cluster 2>/dev/null || \
  k3d cluster create my-k8s-cluster --wait
fi
kubectl wait --for=condition=Ready nodes --all --timeout=120s

echo "=== Installing Gateway API CRDs (experimental) ==="
kubectl apply --server-side -f https://github.com/kubernetes-sigs/gateway-api/releases/download/v1.4.0/experimental-install.yaml

echo "=== Installing Enterprise AgentGateway CRDs ==="
helm upgrade -i --create-namespace --namespace enterprise-agentgateway \
  --version 2.1.1 enterprise-agentgateway-crds \
  oci://us-docker.pkg.dev/solo-public/enterprise-agentgateway/charts/enterprise-agentgateway-crds

echo "=== Installing Enterprise AgentGateway Controller ==="
helm upgrade -i -n enterprise-agentgateway enterprise-agentgateway \
  oci://us-docker.pkg.dev/solo-public/enterprise-agentgateway/charts/enterprise-agentgateway \
  --version 2.1.1 \
  --set-string licensing.licenseKey="${AGENTGATEWAY_LICENSE_KEY}" \
  -f -<<HELMEOF
gatewayClassParametersRefs:
  enterprise-agentgateway:
    group: enterpriseagentgateway.solo.io
    kind: EnterpriseAgentgatewayParameters
    name: agentgateway-params
    namespace: enterprise-agentgateway
HELMEOF

kubectl -n enterprise-agentgateway wait --for=condition=Available deployment --all --timeout=180s

echo "=== Installing Monitoring Stack (Tempo + Grafana + Prometheus) ==="
helm repo add grafana https://grafana.github.io/helm-charts
helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
helm repo update

# Tempo for tracing
helm upgrade --install tempo grafana/tempo-distributed \
  --namespace monitoring --create-namespace --wait \
  --values - <<TEMPOEOF
minio:
  enabled: false
traces:
  otlp:
    grpc:
      enabled: true
    http:
      enabled: true
  zipkin:
    enabled: false
  jaeger:
    thriftHttp:
      enabled: false
  opencensus:
    enabled: false
TEMPOEOF

# Grafana + Prometheus
helm upgrade --install grafana-prometheus prometheus-community/kube-prometheus-stack \
  --version 80.4.2 --namespace monitoring --wait \
  --values - <<GRAFEOF
alertmanager:
  enabled: false
grafana:
  adminPassword: "solo-demo"
  service:
    type: ClusterIP
    port: 3000
  additionalDataSources:
  - name: Tempo
    type: tempo
    access: proxy
    url: "http://tempo-query-frontend.monitoring.svc.cluster.local:3200"
    uid: 'local-tempo-uid'
  sidecar:
    dashboards:
      enabled: true
      label: grafana_dashboard
      labelValue: "1"
      searchNamespace: monitoring
nodeExporter:
  enabled: false
prometheus:
  service:
    type: ClusterIP
  prometheusSpec:
    ruleSelectorNilUsesHelmValues: false
    serviceMonitorSelectorNilUsesHelmValues: false
    podMonitorSelectorNilUsesHelmValues: false
GRAFEOF

# PodMonitor for AgentGateway metrics
kubectl apply -f- <<PMEOF
apiVersion: monitoring.coreos.com/v1
kind: PodMonitor
metadata:
  name: agentgateway-metrics
  namespace: enterprise-agentgateway
spec:
  namespaceSelector:
    matchNames:
      - enterprise-agentgateway
  podMetricsEndpoints:
    - port: metrics
  selector:
    matchLabels:
      app.kubernetes.io/name: agentgateway
PMEOF

# Create OpenAI k8s secret
if [ -n "${OPENAI_API_KEY:-}" ]; then
  kubectl create secret generic openai-secret -n enterprise-agentgateway \
    --from-literal="Authorization=Bearer $OPENAI_API_KEY" \
    --dry-run=client -oyaml | kubectl apply -f -
fi

# Pre-pull MCP server image
docker pull ghcr.io/peterj/mcp-website-fetcher:main || true
k3d image import ghcr.io/peterj/mcp-website-fetcher:main -c my-k8s-cluster || true

# Port-forward Grafana as systemd service (port 3000)
cat <<SVCEOF >/etc/systemd/system/grafana.service
[Unit]
Description=Grafana Port Forward
After=cloud-final.service
[Service]
Restart=always
RestartSec=5s
Environment="KUBECONFIG=/root/.kube/config"
ExecStart=/usr/local/bin/kubectl -n monitoring port-forward svc/grafana-prometheus 3000:3000 --address 0.0.0.0
[Install]
WantedBy=multi-user.target
SVCEOF
systemctl daemon-reload
systemctl enable grafana
systemctl start grafana

# Install Node.js for MCP Inspector
export NVM_DIR="/root/.nvm"
[ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"
if ! command -v node >/dev/null 2>&1; then
  nvm install 20 || true
fi

echo "=== Track setup complete ==="
