#!/bin/bash
set -euxo pipefail
if ! kubectl get enterpriseagentgatewayparameters agentgateway-params -n enterprise-agentgateway &>/dev/null; then
  fail-message "EnterpriseAgentgatewayParameters 'agentgateway-params' not found."
fi
if ! kubectl get gateway agentgateway -n enterprise-agentgateway &>/dev/null; then
  fail-message "Gateway 'agentgateway' not found."
fi
# Give the proxy pod up to 90s to come up
for i in $(seq 1 18); do
  if kubectl get pods -n enterprise-agentgateway -l app.kubernetes.io/name=agentgateway --no-headers 2>/dev/null | grep -q Running; then
    exit 0
  fi
  sleep 5
done
fail-message "Agentgateway proxy pod is not running yet. Wait a moment and try again."
